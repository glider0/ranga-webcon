<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
	<title>NSWA Ranga</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<meta name="referrer" content="no-referrer">

	<link href="../styles/main.css?v=__RELVERSION__" rel="stylesheet">
	<link href="../styles/dialog.css?v=__RELVERSION__" rel="stylesheet">
	<style type="text/css">
		body {
			margin: 0;
			background-color: #f4f4f4;
			font-family: sans-serif;

			padding: 60px;
		}

		.card {
			max-width: 600px;
			margin: 0 auto;

			display: none;

			flex-flow: column;
			justify-content: flex-start;
			padding: 20px;
		}

		#btns {
			margin-top: 12px;
		}

		@media (max-width: 750px) {
			body {
				padding: 15px;
			}
		}

	</style>
</head>

<body>
	<div class="card" style="display: flex;">
		<div id="main">

		</div>
		<div id="btns">
			<button id="install" class="btnFlat">继续</button><button class="btnFlat" onclick="back();">拒绝</button>
		</div>
	</div>

	<script src="../scripts/utils.js?v=__RELVERSION__"></script>
	<script src="../scripts/ranga.js?v=__RELVERSION__"></script>
	<script src="../scripts/webcon.js?v=__RELVERSION__"></script>
	<script src="../scripts/dialog.js?v=__RELVERSION__"></script>
	<script src="/cgi-bin/jshelper?action=get-lan-ip"></script>
	<script>
		var uriParams = {};

		const defErrorHandler = proto => {
			utils.promiseDebug(proto);
			dialog.simple(utils.isNil(proto) ? "网络错误或 Web 控制台错误" : ranga.errstr(proto.code));
		}

		const uriDomain = uri => {
			let a = document.createElement('a');
			a.href = uri;
			return a.hostname;
		}

		const back = () => {
			if ('return_to' in uriParams) {
				window.location.href = uriParams.return_to;
			} else {
				window.close();
				window.location.href = 'about:blank';
			}
		}

		let match,
			search = /([^&=]+)=?([^&]*)/g,
			decode = (s => decodeURIComponent(s.replace(/\+/g, " "))),
			query = window.location.search.substring(1);

		while (match = search.exec(query))
			uriParams[decode(match[1])] = decode(match[2]);

		let div = document.getElementById('main');

		if ('action' in uriParams) {
			switch (uriParams.action) {
				case 'insext':
					if (!('download_uri' in uriParams)) {
						alert('Invalid argument');
						back();
					}
					div.innerHTML = '位于 <b>' + utils.raw2HTMLString(uriDomain(uriParams.download_uri)) + '</b> 的站点正试图向你的 NSWA Ranga 安装扩展程序。安装第三方扩展程序可能对 NSWA Ranga 系统性能和稳定性产生不良影响。请仅在十分清楚的情况下继续操作。';
					if (!uriParams.download_uri.startsWith('https:')) {
						div.innerHTML += '<br><br>您与此站点的连接不是私密连接。这意味着你的数据未经加密在互联网上传输，这可能导致扩展程序被恶意替换。';
					}

					document.getElementById('install').addEventListener('click', e => {
						let d = null,
							passwd = prompt('若要安装扩展程序，您必须经过认证\n\n输入超级用户密码继续', 'ranga');
						ranga.api.auth(passwd).then(proto => {
							webcon.setToken(proto.payload);
							d = dialog.show(null, null, "正在下载更新...", []);
							return utils.ajaxGet2(uriParams.download_uri, true);
						}).catch(() => {
							alert('无法从该站点下载数据');
							dialog.close(d);
							return Promise.reject();
						}).then(blob => {
							dialog.textWidget(d).textContent = '正在安装';
							return ranga.api.addonInstall(blob);
						}).then(proto => {
							dialog.close(d);
							dialog.show(null, null, "<pre>" + utils.raw2HTMLString(proto.payload) + "</pre>", [{
								name: '完成',
								func: back
							}]);
						}).catch(defErrorHandler);
					});
					break;
				case 'instheme':
					if ('_NSWARangaINET4Addr' in window) {
						let extraInetAddr = window['_NSWARangaINET4Addr'];
						if (window.location.host !== extraInetAddr) {
							dialog.show(null, null, "是否跳转到 <b>" + extraInetAddr + "</b>？如果不跳转，主题将会被安装到 <b>" + window.location.host + "</b> 域上的 Web 控制台", [{
								name: "跳转",
								func: (d => {
									window.location.href = "http://" + extraInetAddr + window.location.pathname + window.location.search;
								})
							}, {
								name: "不跳转",
								func: dialog.close
							}]);
						}
					}
					if (!('download_uri' in uriParams) || !('theme_uuid' in uriParams) || !('theme_version' in uriParams)) {
						alert('Invalid argument');
						back();
					}
					div.innerHTML = '位于 <b>' + utils.raw2HTMLString(uriDomain(uriParams.download_uri)) + '</b> 的站点正试图向你的 NSWA Ranga 的 Web 控制台设置自定义主题。安装第三方主题可能会导致 Web 控制台外观被恶意篡改，从而使你受骗。';
					if (!uriParams.download_uri.startsWith('https:')) {
						div.innerHTML += '<br><br>您与此站点的连接不是私密连接。这意味着你的数据未经加密在互联网上传输，这可能导致主题被恶意替换。';
					}

					document.getElementById('install').addEventListener('click', e => {
						let d = dialog.show(null, null, "正在下载主题...", []);
						let db;

						utils.ajaxGet2(uriParams.download_uri, false).then(css => {
							let request = indexedDB.open('webcon', 1);
							request.onerror = function(event) {
								console.log('indexedDB open error');
							};

							request.onsuccess = function(event) {
								db = request.result;

								let tran = db.transaction(['theme'], 'readwrite')
									.objectStore('theme')
									.put({
										id: 'custom-css',
										data: css,
										theme_uuid: uriParams.theme_uuid,
										theme_version: uriParams.theme_version
									});

								tran.onsuccess = function(event) {
									back();
								};

								tran.onerror = function(event) {
									console.log('indexedDB update error');
								}
							};

							request.onupgradeneeded = function(event) {
								db = event.target.result;
								var objectStore;
								if (!db.objectStoreNames.contains('theme')) {
									objectStore = db.createObjectStore('theme', {
										keyPath: 'id'
									});
								}
							}
						}).catch((str) => {
							alert('无法从该站点下载数据');
							dialog.close(d);
							return Promise.reject();
						});
					});
					break;
				default:
					alert('无法理解的操作');
					back();
					break;
			}
		} else {
			back();
		}

	</script>
</body>

</html>
